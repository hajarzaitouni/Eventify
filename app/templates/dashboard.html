{% extends 'layout.html'%}
{% block navbar %}
<a class="navbar-brand" href="{{ url_for('home') }}">
    <img src="../static/images/logo.png" alt="logo_Eventify" style="width: 220px; padding-left: 25px" loading="lazy" />
</a>
<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
    aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
</button>
<div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav ml-auto">
        <li class="nav-item">
            <a class="nav-link" href="{{ url_for('home') }}">Home</a>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-toggle="modal" data-target="#createEventModal">
                Create Event
            </button>
        </li>
        <li class="nav-item">
            <!--<a class="nav-link" href="{{ url_for('show_archived_events') }}">Archive</a>-->
            <button class="btn btn-outline-primary nav-link"
                onclick="window.location.href='{{ url_for('show_archived_events') }}'">
                Archive
            </button>
        </li>
        <li class="nav-item">
            <button class="btn btn-primary" onclick="window.location.href='{{ url_for('logout') }}'">
                Logout
            </button>
        </li>
    </ul>
</div>
{% endblock %}
{% block welcome_content %}
<section class="welcome-content">
    <div class="container text-center">
        <div class="row">
            <div class="col-md-12">
                <h1>Hello {{ username }}!</h1>
                <h2>See what's coming next</h2>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block content %}
<section>
    <div class="events-section" style="margin: 20px 20px;">
        <h2 class="text-center">My Events</h2>
        {% if events %}
        <div class="row">
            {% for event in events %}
            <div class="col-md-4 mb-4">
                <form action="{{ url_for('archive_event', event_id=event.event_id) }}" method="post"
                    class="archive-form">
                    <div class="card" style="cursor: pointer">
                        {% if event.thumbnail %}
                        <img src="{{ url_for('static', filename='images/thumbnail_pics/' + event.thumbnail) }}"
                            class="card-img-top" alt="event_image" />
                        {% else %}
                        <img src="https://via.placeholder.com/350x200" class="card-img-top" alt="event_image" />
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ event.event_name }}</h5>
                            <p class="card-text">{{ event.event_description }}</p>
                            <div class="cards-buttons">
                                <button type="button" class="btn btn-primary update-event-button" data-event-id="{{ event.event_id }}"
                                    data-event-name="{{ event.event_name }}" data-event-location="{{ event.event_location }}"
                                    data-event-date="{{ event.event_date }}" data-event-end="{{ event.event_end }}"
                                    data-event-description="{{ event.event_description }}" data-toggle="modal" data-target="#updateEventModal">
                                    Update
                                </button>
                                <a href="{{ url_for('delete_event', event_id=event.event_id) }}" class="btn btn-danger">Delete</a>
                                <button type="submit" class="btn btn-warning">Archive</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center">
            <h3>No events created yet. Start creating your events Now!</h3>
            <button class="btn btn-primary" data-toggle="modal" data-target="#createEventModal">
                Create Event
            </button>
        </div>
        {% endif %}
    </div>
</section>
{% include 'create_event.html' %}
{% include 'update_event.html' %}
{% endblock%}

{% block extra_js %}
<script>
    $(document).ready(function () {
        // Add dashboard-top-section class to top-section
        $('.top-section').addClass('dashboard-top-section');

        // Scroll to events section
        $('#showEventsButton').click(function () {
            $('html, body').animate(
                {
                    scrollTop: $('.events-section').offset().top,
                },
                1000
            );
        });
    });

    $(document).ready(function () {
        // Automatically show the update modal if the URL hash is set
        if (window.location.hash.startsWith('#updateEventModal')) {
            $('#updateEventModal').modal('show');
        }

        // Handle the update event form submission via AJAX
        $('#updateEventForm').submit(function (event) {
            event.preventDefault();

            let formData = new FormData(this);
            let eventId = $('#updateEventForm').data('event-id'); // Assuming you set this data attribute when opening the modal

            fetch(`/dashboard/update/${eventId}`, {
                method: 'POST',
                body: formData,
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        window.location.reload(); // Reload the page to show updated event details
                    } else {
                        $('#updateAlertMessage')
                            .removeClass('d-none')
                            .addClass('alert-danger')
                            .html(data.message);
                    }
                })
                .catch((err) => {
                    $('#updateAlertMessage')
                        .removeClass('d-none')
                        .addClass('alert-danger')
                        .html('An error occurred. Please try again.');
                });
        });

        // Pre-fill the modal with event data when the update button is clicked
        $('.update-event-button').on('click', function () {
            let eventId = $(this).data('event-id');
            let eventName = $(this).data('event-name');
            let eventLocation = $(this).data('event-location');
            let eventDate = $(this).data('event-date');
            let eventEnd = $(this).data('event-end');
            let eventDescription = $(this).data('event-description');

            // Set form data in the modal
            $('#updateEventForm').data('event-id', eventId);
            $('#updateEventModal #event_name').val(eventName);
            $('#updateEventModal #event_location').val(eventLocation);
            $('#updateEventModal #event_date').val(eventDate);
            $('#updateEventModal #event_end').val(eventEnd);
            $('#updateEventModal #event_description').val(eventDescription);
            $('#updateEventModal #thumbnail').val(''); // Clear the thumbnail input

            // Show the modal
            $('#updateEventModal').modal('show');
        });
    });
</script>
<script>
    $(document).ready(function () {
        if (window.location.hash === '#createEventModal') {
            $('#createEventModal').modal('show');
        }
        const urlParams = new URLSearchParams(window.location.search);
        const show_modal = urlParams.get('show_modal');

        if (show_modal === 'true') {
            $('#createEventModal').modal('show');
        }

        $('#createEventForm').submit(function (event) {
            event.preventDefault();

            let formData = new FormData(this);

            fetch('/dashboard/create', {
                method: 'POST',
                body: formData,
            })
                .then((res) => res.json())
                .then((data) => {
                    console.log('data :', data);
                    if (data.success) {
                        window.location.reload();
                    } else {
                        $('#createAlertMessage')
                            .removeClass('d-none')
                            .addClass('alert-danger')
                            .html(data.message);
                    }
                })
                .catch((err) => {
                    $('#createAlertMessage')
                        .removeClass('d-none')
                        .addClass('alert-danger')
                        .html('An error occurred. Please try again.');
                });
        });
    });
</script>
{% endblock %}